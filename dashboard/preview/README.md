# Preview 模块说明文档

## 模块概述

Preview模块是一个高频经济数据分析系统，专门用于处理、分析和可视化周度、月度工业经济指标数据。该模块提供完整的数据处理流水线，从数据加载到深度分析和可视化展示。

## 主要板块和功能

### 1. 数据处理板块
- **数据加载和预处理**
- **数据标准化和清洗**
- **多频率数据整合**
- **行业分类映射**

### 2. 分析计算板块
- **增长率计算**（环比、同比）
- **历史统计分析**（近5年最值、均值）
- **扩散指数计算**
- **行业对比分析**

### 3. 可视化板块
- **时间序列图表**
- **热力图分析**
- **行业对比图**
- **扩散指数图**

### 4. 交互界面板块
- **数据上传界面**
- **多标签页展示**
- **动态筛选和选择**
- **数据下载功能**

## 文件结构图

```
dashboard/preview/
├── README.md                 # 本文档
├── __init__.py              # 模块初始化
├── data_loader.py           # 数据加载和预处理核心模块
├── growth_calculator.py     # 增长率计算模块
├── diffusion_analysis.py    # 扩散分析模块
├── weekly_data_tab.py       # 周度数据标签页
├── monthly_data_tab.py      # 月度数据标签页
├── industrial_data_tab.py   # 工业数据主标签页
└── plotting_utils.py        # 绘图工具模块
```

## 核心功能详细说明

### 1. 数据加载模块 (`data_loader.py`)

#### 主要功能
- 从Excel文件读取多sheet数据
- 自动识别数据频率（日度、周度、月度）
- 数据清洗和标准化处理
- 构建指标来源映射

#### 核心函数

**`load_and_process_data(excel_files_input: List[Any])`**
- **输入**: Excel文件列表（路径或上传对象）
- **处理流程**:
  1. 遍历所有Excel文件
  2. 根据sheet名称判断数据类型：
     - 包含"周度" → 周度数据
     - 包含"月度" → 月度数据  
     - 包含"日度" → 日度数据（转换为周度）
  3. 数据预处理：
     - 日期列解析和索引设置
     - 数值列转换：`pd.to_numeric()`
     - 近零值和零值替换为NaN
     - 重复日期处理（保留最后一个）
  4. 频率转换：
     - 周度数据：`resample('W-FRI').last()`
     - 日度数据：`resample('W-FRI').mean()`
     - 月度数据：保持原频率
- **输出**: (周度DataFrame, 月度DataFrame, 指标来源映射, 行业映射)

**`normalize_string(s: str)`**
- **功能**: 字符串标准化处理
- **处理规则**:
  - 全角转半角：`（）：　` → `(): `
  - 冒号后添加空格：`：` → `: `
  - 去除首尾空格，合并多余空格

### 2. 增长率计算模块 (`growth_calculator.py`)

#### 周度增长率计算 (`calculate_weekly_growth_summary`)

**计算公式**:
- **环比上周**: `(当期值 - 上周值) / |上周值|`
- **环比上月**: `(当期值 - 4周前值) / |4周前值|`  
- **同比上年**: `(当期值 - 52周前值) / |52周前值|`

**历史统计**:
- **统计期间**: 当前年份前5年（不含当前年）
- **最大值**: `历史数据.max()`
- **最小值**: `历史数据.min()`
- **平均值**: `历史数据.mean()`

#### 月度增长率计算 (`calculate_monthly_growth_summary`)

**计算公式**:
- **环比上月**: `当期值 - 上月值`（差值）
- **同比上年**: `当期值 - 去年同月值`（差值）

**注意**: 月度计算使用差值而非比率，这是因为工业增加值等指标的特性。

### 3. 扩散分析模块 (`diffusion_analysis.py`)

#### 扩散指数计算

**计算公式**:
```
扩散指数 = (增长指标数量 / 总有效指标数量) × 100%
```

**参数设置**:
- **周同比扩散指数**: 
  - 计算周期：52周
  - 阈值范围：-25% 至 50%
  - 默认阈值：0%
- **周环比扩散指数**:
  - 计算周期：1周  
  - 阈值范围：-10% 至 20%
  - 默认阈值：0%

#### 热力图生成

**数据准备**:
1. 计算指定周期的百分比变化：`df.pct_change(periods=N) * 100`
2. 选择最近15周数据
3. 按行业分组排序
4. 按最新值降序排序

**颜色映射**:
- 绿色：负增长 (`value < 0`)
- 白色：零增长 (`value = 0`)
- 红色：正增长 (`value > 0`)

### 4. 绘图工具模块 (`plotting_utils.py`)

#### 周度指标绘图 (`plot_weekly_indicator`)

**历史统计计算**:
```python
# 按周数分组计算历史统计
historical_stats = historical_data.groupby(week_number).agg({
    'hist_min': 'min',
    'hist_max': 'max', 
    'hist_mean': 'mean'
})
```

**图表元素**:
- 灰色区域：历史最大值-最小值区间
- 灰色虚线：历史平均值
- 蓝色实线：上年数据
- 红色实线：当年数据

#### 月度指标绘图 (`plot_monthly_indicator`)

**计算逻辑**:
- X轴：月份（1-12）
- Y轴：当月同比增长率
- 历史区间：前N年同月数据的最值区间

### 5. 标签页模块

#### 周度数据标签页 (`weekly_data_tab.py`)

**主要功能**:
1. 行业选择和数据筛选
2. 周度摘要表生成和排序
3. 指标时间序列图表展示
4. 按环比增长率分列显示

#### 月度数据标签页 (`monthly_data_tab.py`)

**主要功能**:
1. 月度摘要表计算和显示
2. 月度指标图表生成
3. 数据格式化和样式设置

#### 工业数据主标签页 (`industrial_data_tab.py`)

**主要功能**:
1. 数据上传和预处理协调
2. 多个子标签页管理
3. 总体概览统计
4. 扩散分析集成

## 数据验证和检查

### 1. 数据完整性检查
- 日期连续性验证
- 缺失值比例统计
- 数据类型一致性检查

### 2. 计算准确性验证
- 增长率计算结果抽查
- 历史统计数值验证  
- 扩散指数计算验证

### 3. 可视化准确性
- 图表数据点验证
- 颜色映射正确性
- 坐标轴标签准确性

## 使用流程

1. **数据上传**: 通过文件上传器选择Excel文件
2. **数据处理**: 自动进行数据清洗和预处理
3. **分析计算**: 计算各类增长率和统计指标
4. **结果展示**: 通过多个标签页展示分析结果
5. **数据下载**: 导出处理后的数据和分析结果

## 技术要求

- Python 3.8+
- pandas >= 1.3.0
- streamlit >= 1.20.0
- plotly >= 5.0.0
- numpy >= 1.20.0
- openpyxl >= 3.0.0

## 注意事项

1. **数据格式要求**: Excel文件需包含明确的sheet命名（包含"周度"、"月度"、"日度"等关键词）
2. **日期格式**: 支持多种日期格式，但建议使用标准日期格式
3. **性能考虑**: 大数据量时建议分批处理
4. **内存管理**: 处理多个大文件时注意内存使用

## 更新日志

- v1.0: 初始版本，包含基本数据处理和分析功能
- v1.1: 增加扩散分析模块
- v1.2: 优化数据处理性能，增加热力图功能
- v1.3: 完善用户界面，增加数据下载功能 